---
layout: post
comments: false
title: "使用frp实现内网穿透"
date: 2021-7-12
tags: ubuntu
---

世界上最遥远的距离就是校外的我和实验室服务器之间的距离，我在公网，服务器在校内网。

<!--more-->

# 什么是内网穿透
由于实验室或者家中连接的服务器以及NAS等上网设备都处在内网之中，这些设备上网都是通过内网路由器的NAT服务与公网设备交换信息。而家中的路由器其实也分配的是运营商小区内网的IP地址，进入公网又需要通过小区路由器的NAT服务进行地址转换，反复套娃。

NAT机制的问题在于，NAT设备会自动屏蔽非内网主机主动发起的连接，也就是说从公网主动发往内网的数据包将被NAT丢弃，而且由于内网中设备的IP是动态分配的，同一个设备在不同时间段使用的可能是不同的IP，因此，从公网通过IP直接访问到内网的某个设备显然是不可能的。而内网穿透就是一种可以让公网设备访问到内网设备的服务。

内网穿透的实现方法主要有两种：动态域名解析DDNS以及反向代理。

其中DDNS的使用场景是家中的拨号网络有公网IP，虽然每次拨号时分配的IP不同，但可以通过DDNS服务在每次拨号后自动将分配的公网IP解析到设置的域名中，这样通过域名就可以直接访问到内网的服务器。

由上可见，DDNS服务是一种简单快捷的内网穿透方法，但要求家中的拨号网络有公网IP，这个要求就十分高了，目前很难从运营商手中要到公网IP，而且也不适用于校园网穿透的场景。

第二种方法就是反向代理，通过一台具有公网IP的服务器作为跳板，在公网服务器中启动反向代理服务同时在内网路由器或主机上启动另一个映射服务，那么就可以通过公网服务器中转来达到内网穿透的效果。

当然，如果公网和内网环境都有IPv6地址的话，就不用这么麻烦直接访问就完事了。

# frp介绍
简单的说，frp是一个开源反向代理软件。它可以使处于内网或防火墙后的机器通过公网中的跳板对外界提供服务。它支持网络传输层的TCP，UDP协议，显然基于这两种协议的应用层协议，比如HTTP，DNS，SSH等也都在支持范围内。

frp的GitHub仓库地址：https://github.com/fatedier/frp

# 准备工作
搭建一套完整的frp服务，需要准备如下内容：
1. 一台具有公网IP的服务器或云主机
2. 最新的frp软件包（[Github](https://github.com/fatedier/frp/releases)）

# 服务器端配置

我使用的是阿里云的轻量应用服务器，可以在服务器shell中使用`wget`命令下载frp软件包，也可以预先下载好上传到服务器中。

之后就是常规的解压操作（备注：`tar`常用命令中 `-zcvf`是压缩，`-zxvf`是解压）在解压后，服务器端只需要关注`frps`可执行文件和`frps.ini`配置文件。

通过`frps.ini`配置文件，可以对frp服务进行配置，例如我需要代理内网服务器的ssh服务和jupyter notebook网页服务（UnFinished）