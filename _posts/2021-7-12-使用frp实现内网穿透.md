---
layout: post
comments: false
title: "使用frp实现内网穿透"
date: 2021-7-12
tags: ubuntu
---

> 世界上最遥远的距离就是校外的我和实验室服务器之间的距离，我在公网，服务器在校内网。

<!--more-->

# 什么是内网穿透
由于实验室或者家中连接的服务器以及NAS等上网设备都处在内网之中，这些设备上网都是通过内网路由器的NAT服务与公网设备交换信息。而家中的路由器其实也分配的是运营商小区内网的IP地址，进入公网又需要通过小区路由器的NAT服务进行地址转换，反复套娃。

NAT机制的问题在于，NAT设备会自动屏蔽非内网主机主动发起的连接，也就是说从公网主动发往内网的数据包将被NAT丢弃，而且由于内网中设备的IP是动态分配的，同一个设备在不同时间段使用的可能是不同的IP，因此，从公网通过IP直接访问到内网的某个设备显然是不可能的。而内网穿透就是一种可以让公网设备访问到内网设备的服务。

内网穿透的实现方法主要有两种：动态域名解析DDNS以及反向代理。

其中DDNS的使用场景是家中的拨号网络有公网IP，虽然每次拨号时分配的IP不同，但可以通过DDNS服务在每次拨号后自动将分配的公网IP解析到设置的域名中，这样通过域名就可以直接访问到内网的服务器。

由上可见，DDNS服务是一种简单快捷的内网穿透方法，但要求家中的拨号网络有公网IP，这个要求就十分高了，目前很难从运营商手中要到公网IP，而且也不适用于校园网穿透的场景。

第二种方法就是反向代理，通过一台具有公网IP的服务器作为跳板，在公网服务器中启动反向代理服务同时在内网路由器或主机上启动另一个映射服务，那么就可以通过公网服务器中转来达到内网穿透的效果。

当然，如果公网和内网环境都有IPv6地址的话，就不用这么麻烦直接访问就完事了。

# frp介绍
简单的说，frp是一个开源反向代理软件。它可以使处于内网或防火墙后的机器通过公网中的跳板对外界提供服务。它支持网络传输层的TCP，UDP协议，显然基于这两种协议的应用层协议，比如HTTP，DNS，SSH等也都在支持范围内。

frp的GitHub仓库地址：https://github.com/fatedier/frp

# 准备工作
搭建一套完整的frp服务，需要准备如下内容：
1. 一台具有公网IP的服务器或云主机
2. 最新的frp软件包（[Github](https://github.com/fatedier/frp/releases)）

# 服务器端配置

我使用的是阿里云的轻量应用服务器，可以在服务器shell中使用`wget`命令下载frp软件包，也可以预先下载好上传到服务器中。

之后就是常规的解压操作（备注：`tar`常用命令中 `-zcvf`是压缩，`-zxvf`是解压）在解压后，服务器端只需要关注`frps`可执行文件和`frps.ini`配置文件。

通过`frps.ini`配置文件，可以对frp服务进行配置，服务器端需要的基本配置有frp客户端与服务器端通信的端口和连接密码（token）。frp的服务器端还带有简单的统计仪表盘页面，可以在服务器端配置dashboard参数启动，配置例子如下:
```
[common]
bind_port = 7000 #绑定端口号 和之后客户端的要对应
dashboard_port = 7500 #控制面板的端口号
token = xxxxxxxx #密码，明文保存
dashboard_user = admin #仪表面板的账号，默认admin
dashboard_pwd = admin #仪表面板的密码，默认admin
```
其他还有更多的参数，可以参考GitHub中的README文档。

修改完成之后，就可以运行frps的服务器部分了

`./frps -c frps.ini`

这时，如果我们关闭连接界面，或者使用Ctrl+C停止后，frps均会停止运行，因此我们可以使用nohup命令将其运行在后台。

`nohup ./frps -c frps.ini >/dev/null 2>log &`

此时frps就已经正常运行，访问x.x.x.x:7500就能打开仪表面板。至此，服务器端就已经设置完成。

# 客户端配置
frp的客户端即是我们真正想要访问的内网设备。

首先也是将准备时下载的frp软件包上传到备上，常规解压缩，不过和服务器端配置不同的是，在客户端中，我们修改和使用的是frpc和frpc.ini两个文件。

通过frpc.ini文件，我们可以对frp客户端进行配置。我的目的是访问ssh服务以及jupyter服务。因此我的配置文件如下：

```[common]
server_addr = x.x.x.x #填写frp服务器端的ip地址
server_port = 7000 #填写frp服务器端的bind_port绑定端口号
token = xxxxxxxx #填写服务器端设置的token密码，同样也是明文
tls_enable = true #开启tls协议加密，不开启的话会连接不上服务器
 
[ssh]
type = tcp
local_ip = 127.0.0.1
local_port = 22
remote_port = 6000 #代理端口号，即在服务器端开放的端口号
 
[jupyterbook]
type = tcp
local_ip = 127.0.0.1
local_port = 8888
remote_port = 9999
```
同样也可以设置更多的规则来访问其他内网端口

配置完成后，就可以运行frpc了

`./frpc -c frpc.ini`

此时我们就可以通过服务器的公网ip + 客户端中设定的remote_port进行内网穿透访问。

比如，在我的配置中，ssh登录的ip是服务器IP，端口号是6000。访问服务器jupyter的URL就是x.x.x.x:9999（x.x.x.x为服务器IP）

同理，我们也可以使用nohup来将客户端的frp程序指定为后台运行。

`nohup ./frpc -c frpc.ini >/dev/null 2>log &`

至此，frp服务就顺利搭建完成。